// Schema Prisma - Seidmann Institute
// Banco de dados: MySQL (seidmann_app)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum EnrollmentStatus {
  LEAD
  REGISTERED
  CONTRACT_ACCEPTED
  PAYMENT_PENDING
  ACTIVE
  INACTIVE   // Aluno inativo
  PAUSED     // Aluno pausado
  BLOCKED
  COMPLETED
}

enum Language {
  ENGLISH  // Inglês
  SPANISH  // Espanhol
}

enum PaymentMethod {
  PIX
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
  BLOCKED
}

enum AttendanceType {
  STUDENT
  TEACHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

enum AnnouncementChannel {
  EMAIL
  SMS
}

enum AnnouncementStatus {
  PENDING
  SENT
  CANCELED
}

// Model: User (Usuário)
// Representa um usuário cadastrado no sistema
model User {
  id           String       @id @default(cuid())
  nome         String
  email        String       @unique
  whatsapp     String
  senha        String       @map("password_hash") // Hash da senha (bcrypt)
  role         UserRole     @default(STUDENT) // ADMIN, TEACHER, STUDENT
  status       UserStatus   @default(PENDING) // PENDING, ACTIVE, BLOCKED
  funcao       String?      @db.VarChar(255) @map("funcao") // Função/cargo (para usuários do ADM)
  adminPages   Json?        @map("admin_pages") // Páginas do dashboard que pode acessar (array de strings)
  criadoEm     DateTime     @default(now()) @map("created_at")
  atualizadoEm DateTime     @updatedAt @map("updated_at")
  
  // Relacionamentos
  enrollments        Enrollment[]
  attendances        Attendance[]
  bookReleases       BookRelease[]
  teacher            Teacher?
  teacherAlertsCreated TeacherAlert[]
  studentAlertsCreated StudentAlert[]
  
  // Índices
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

// Model: Enrollment (Matrícula / Aluno)
// Representa uma matrícula/lead no sistema
model Enrollment {
  id             String           @id @default(cuid())
  userId         String?          @map("user_id")
  
  // Dados básicos
  nome           String
  email          String
  whatsapp       String
  idioma         Language?    // Opcional
  nivel          String?
  objetivo       String?
  disponibilidade String?
  
  // Dados completos do aluno (cadastro admin)
  dataNascimento   DateTime?     @map("data_nascimento")
  nomeResponsavel  String?        @db.VarChar(255) @map("nome_responsavel") // se menor
  cpf              String?        @db.VarChar(14)
  cpfResponsavel   String?        @db.VarChar(14) @map("cpf_responsavel")   // se menor
  curso            String?        @db.VarChar(50)  // INGLES, ESPANHOL, INGLES_E_ESPANHOL
  frequenciaSemanal Int?          @map("frequencia_semanal") // 1-7
  tempoAulaMinutos  Int?          @map("tempo_aula_minutos") // 30, 40, 60, 120
  tipoAula         String?        @db.VarChar(20) @map("tipo_aula") // PARTICULAR, GRUPO
  nomeGrupo        String?        @db.VarChar(255) @map("nome_grupo") // quando tipoAula = GRUPO
  cep               String?       @db.VarChar(9)
  rua               String?      @db.VarChar(255)
  cidade            String?      @db.VarChar(100)
  estado            String?      @db.VarChar(2)
  numero            String?      @db.VarChar(20)
  complemento       String?      @db.VarChar(255)
  moraNoExterior    Boolean      @default(false) @map("mora_no_exterior")
  enderecoExterior  String?      @db.Text @map("endereco_exterior")
  valorMensalidade  Decimal?     @db.Decimal(10, 2) @map("valor_mensalidade")
  metodoPagamento   String?      @db.VarChar(50) @map("metodo_pagamento")
  diaPagamento      Int?         @map("dia_pagamento") // 1-31
  melhoresHorarios  String?      @db.VarChar(255) @map("melhores_horarios")
  melhoresDiasSemana String?     @db.VarChar(255) @map("melhores_dias_semana")
  nomeVendedor      String?      @db.VarChar(255) @map("nome_vendedor")
  nomeEmpresaOuIndicador String?  @db.VarChar(255) @map("nome_empresa_ou_indicador")
  observacoes       String?      @db.Text
  
  status         EnrollmentStatus @default(LEAD)
  trackingCode   String?          @unique @map("tracking_code")
  contractAcceptedAt DateTime?    @map("contract_accepted_at")
  contractVersion    String?      @map("contract_version")
  criadoEm       DateTime         @default(now()) @map("created_at")
  atualizadoEm   DateTime         @updatedAt @map("updated_at")
  
  // Relacionamentos
  user           User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  paymentInfo    PaymentInfo?
  alerts         StudentAlert[]
  lessons        Lesson[]
  lessonRecordPresences LessonRecordStudent[]

  @@index([email])
  @@index([whatsapp])
  @@index([trackingCode])
  @@map("enrollments")
}

// Model: PaymentInfo (Informações de Pagamento)
// Informações de pagamento vinculadas a uma matrícula
model PaymentInfo {
  id               String          @id @default(cuid())
  enrollmentId     String          @unique @map("enrollment_id")
  metodo           PaymentMethod   @default(PIX)
  plan             String?         // Ex: "1h semanal", "2h semanais", "grupo 2h"
  valorMensal      Decimal?        @db.Decimal(10, 2) @map("valor_mensal") // Valor combinado mensal
  monthlyValue     Decimal?        @db.Decimal(10, 2) @map("monthly_value")
  dataPagamento    DateTime?       @map("data_pagamento")
  dueDay           Int?            @map("due_day") // Dia do mês (1-31)
  dueDate          DateTime?       @map("due_date") // Data específica de vencimento
  reminderEnabled  Boolean         @default(true) @map("reminder_enabled")
  paymentStatus    String?         @map("payment_status") // "PENDING", "CONFIRMED"
  paidAt           DateTime?         @map("paid_at")
  transactionRef    String?         @map("transaction_ref") // Referência da transação
  lembrete         Boolean         @default(false) // Mantido para compatibilidade
  criadoEm         DateTime        @default(now()) @map("created_at")
  atualizadoEm     DateTime        @updatedAt @map("updated_at")
  
  // Relacionamento
  enrollment       Enrollment      @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@map("payment_info")
}

// Model: Teacher (Professor)
// Representa um professor do instituto
model Teacher {
  id              String       @id @default(cuid())
  nome            String
  nomePreferido   String?      @map("nome_preferido") // Nome que prefere ser chamado
  email           String       @unique
  whatsapp        String?
  cpf             String?      // CPF (opcional)
  cnpj            String?      // CNPJ (opcional)
  valorPorHora    Decimal?     @db.Decimal(10, 2) @map("valor_por_hora")
  metodoPagamento String?      @map("metodo_pagamento") // PIX, CARTAO
  infosPagamento  String?      @db.Text @map("infos_pagamento")
  nota            Int?         // Avaliação 1-5 estrelas
  status          UserStatus   @default(ACTIVE) // ACTIVE ou INACTIVE
  userId          String?      @unique @map("user_id") // Opcional: link com User se tiver conta
  criadoEm        DateTime     @default(now()) @map("created_at")
  atualizadoEm    DateTime     @updatedAt @map("updated_at")
  
  // Relacionamentos
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  attendances  Attendance[]
  alerts       TeacherAlert[]
  lessons      Lesson[]

  // Índices
  @@index([email])
  @@index([status])
  @@map("teachers")
}

// Model: Attendance (Frequência/Falta)
// Registra presença ou falta de alunos e professores
model Attendance {
  id           String           @id @default(cuid())
  type         AttendanceType   // STUDENT ou TEACHER
  status       AttendanceStatus // PRESENT ou ABSENT (falta = ABSENT)
  userId       String?          @map("user_id") // Para aluno
  teacherId    String?          @map("teacher_id") // Para professor
  date         DateTime         // Data do evento
  notes        String?          // Observações opcionais
  criadoEm     DateTime         @default(now()) @map("created_at")
  atualizadoEm DateTime         @updatedAt @map("updated_at")
  
  // Relacionamentos
  user         User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacher      Teacher?         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Índices para consultas rápidas
  @@index([type, date])
  @@index([userId, date])
  @@index([teacherId, date])
  @@map("attendances")
}

// Model: BookRelease (Liberação de Livro)
// Registra quando um livro foi liberado para um aluno
model BookRelease {
  id                  String   @id @default(cuid())
  userId              String   @map("user_id")
  bookCode            String   // Ex: "BOOK_1", "BOOK_2", etc
  releasedByAdminEmail String  @map("released_by_admin_email")
  criadoEm            DateTime @default(now()) @map("created_at")
  
  // Relacionamento
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Garantir que um aluno não receba o mesmo livro duas vezes
  @@unique([userId, bookCode], name: "userId_bookCode")
  @@index([userId])
  @@index([bookCode])
  @@map("book_releases")
}

// Model: Announcement (Anúncio/Alerta)
// Anúncios enviados para usuários (email ou SMS)
model Announcement {
  id                  String              @id @default(cuid())
  title               String
  message             String
  channel             AnnouncementChannel  // EMAIL ou SMS
  audience            String              // "ALL", "STUDENTS", "TEACHERS", "ACTIVE_ONLY"
  status              AnnouncementStatus  @default(PENDING)
  createdByAdminEmail String              @map("created_by_admin_email")
  sentAt              DateTime?           @map("sent_at")
  criadoEm            DateTime            @default(now()) @map("created_at")
  atualizadoEm        DateTime            @updatedAt @map("updated_at")
  
  // Índices
  @@index([status])
  @@index([channel])
  @@index([criadoEm])
  @@map("announcements")
}

// Model: TeacherAlert (Alerta para Professor)
// Alertas específicos para professores
model TeacherAlert {
  id           String    @id @default(cuid())
  teacherId    String    @map("teacher_id")
  message      String
  level        String?   // "INFO", "WARN", "ERROR"
  isActive     Boolean   @default(true) @map("is_active")
  criadoEm     DateTime  @default(now()) @map("created_at")
  atualizadoEm DateTime  @updatedAt @map("updated_at")
  createdById  String?   @map("created_by_id") // Admin que criou o alerta
  
  // Relacionamentos
  teacher      Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  createdBy    User?     @relation(fields: [createdById], references: [id], onDelete: SetNull)
  
  // Índices
  @@index([teacherId])
  @@index([isActive])
  @@map("teacher_alerts")
}

// Model: StudentAlert (Alerta para Aluno/Matrícula)
// Alertas específicos para alunos (como TeacherAlert para professores)
model StudentAlert {
  id            String     @id @default(cuid())
  enrollmentId  String     @map("enrollment_id")
  message       String
  level         String?    // "INFO", "WARN", "ERROR"
  isActive      Boolean    @default(true) @map("is_active")
  criadoEm      DateTime   @default(now()) @map("created_at")
  atualizadoEm  DateTime   @updatedAt @map("updated_at")
  createdById   String?    @map("created_by_id")

  enrollment    Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  createdBy     User?      @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([isActive])
  @@map("student_alerts")
}

// Status da aula no calendário (segunda a sábado = semana para frequência)
enum LessonStatus {
  CONFIRMED   // Confirmada
  CANCELLED   // Cancelada
  REPOSICAO   // Reposição
}

// Model: Lesson (Aula no calendário)
// Aula agendada: aluno (enrollment) + professor + status + data/hora
model Lesson {
  id                String       @id @default(cuid())
  enrollmentId      String       @map("enrollment_id")
  teacherId         String       @map("teacher_id")
  status            LessonStatus @default(CONFIRMED)
  startAt           DateTime     @map("start_at")
  durationMinutes   Int          @default(60) @map("duration_minutes")
  notes             String?      @db.Text
  criadoEm          DateTime     @default(now()) @map("created_at")
  atualizadoEm      DateTime     @updatedAt @map("updated_at")

  enrollment        Enrollment   @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  teacher           Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  record            LessonRecord?

  @@index([startAt])
  @@index([enrollmentId])
  @@index([teacherId])
  @@map("lessons")
}

// Presença do aluno no registro de aula
enum RecordPresence {
  PRESENTE       // Presente
  NAO_COMPARECEU // Não compareceu
  ATRASADO       // Atrasado
}

// Tipo de aula no registro
enum RecordLessonType {
  NORMAL        // Normal
  CONVERSAÇÃO   // Só conversação
  REVISAO       // Revisão
  AVALIACAO     // Avaliação
}

// Última tarefa feita
enum RecordHomeworkDone {
  SIM          // Sim
  NAO          // Não
  PARCIAL      // Parcial
  NAO_APLICA   // Não aplica
}

// Model: LessonRecord (Registro de aula)
// Registro do que aconteceu na aula: presença, tipo, livro, página, tarefa, notas (se avaliação)
model LessonRecord {
  id                      String            @id @default(cuid())
  lessonId                String            @unique @map("lesson_id")
  status                  LessonStatus      @default(CONFIRMED) // status da aula: confirmada, cancelada, reposição
  presence                RecordPresence    @default(PRESENTE)
  lessonType              RecordLessonType  @default(NORMAL) @map("lesson_type")
  curso                   String?           @db.VarChar(50) // INGLES, ESPANHOL, INGLES_E_ESPANHOL
  tempoAulaMinutos        Int?             @map("tempo_aula_minutos") // preenchido automaticamente da aula selecionada
  book                    String?           @db.VarChar(255) // livro do aluno
  lastPage                String?           @db.VarChar(100) @map("last_page") // última página trabalhada
  assignedHomework        String?           @db.Text @map("assigned_homework") // tarefa designada
  homeworkDone            RecordHomeworkDone? @map("homework_done") // última tarefa feita
  conversationDescription String?           @db.Text @map("conversation_description") // descrição da aula de conversação (quando tipo = Só conversação)
  notes                   String?           @db.Text // obs geral
  notesForStudent         String?           @db.Text @map("notes_for_student") // obs para os alunos
  notesForParents         String?           @db.Text @map("notes_for_parents") // obs para os pais
  gradeGrammar            Float?            @map("grade_grammar")
  gradeSpeaking           Float?            @map("grade_speaking")
  gradeListening          Float?            @map("grade_listening")
  gradeUnderstanding      Float?            @map("grade_understanding")
  criadoEm                DateTime          @default(now()) @map("created_at")
  atualizadoEm            DateTime          @updatedAt @map("updated_at")

  lesson                  Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  studentPresences        LessonRecordStudent[] // quando aula é em grupo: presença por aluno

  @@index([lessonId])
  @@index([status])
  @@map("lesson_records")
}

// Presença por aluno em aula em grupo (um registro por aluno do grupo)
model LessonRecordStudent {
  id              String          @id @default(cuid())
  lessonRecordId  String          @map("lesson_record_id")
  enrollmentId    String          @map("enrollment_id")
  presence        RecordPresence  @default(PRESENTE)

  lessonRecord    LessonRecord    @relation(fields: [lessonRecordId], references: [id], onDelete: Cascade)
  enrollment      Enrollment      @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([lessonRecordId, enrollmentId])
  @@index([lessonRecordId])
  @@index([enrollmentId])
  @@map("lesson_record_students")
}
