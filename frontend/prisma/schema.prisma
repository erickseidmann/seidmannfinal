// Schema Prisma - Seidmann Institute
// Banco de dados: MySQL (seidmann_app)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum EnrollmentStatus {
  LEAD
  REGISTERED
  CONTRACT_ACCEPTED
  PAYMENT_PENDING
  ACTIVE
  INACTIVE   // Aluno inativo
  PAUSED     // Aluno pausado
  BLOCKED
  COMPLETED
}

enum Language {
  ENGLISH  // Ingl├¬s
  SPANISH  // Espanhol
}

enum PaymentMethod {
  PIX
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
  BLOCKED
}

enum AttendanceType {
  STUDENT
  TEACHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

enum AnnouncementChannel {
  EMAIL
  SMS
}

enum AnnouncementStatus {
  PENDING
  SENT
  CANCELED
}

// Model: User (Usu├írio)
// Representa um usu├írio cadastrado no sistema
model User {
  id           String       @id @default(cuid())
  nome         String
  email        String       @unique
  whatsapp     String
  senha        String       @map("password_hash") // Hash da senha (bcrypt)
  role         UserRole     @default(STUDENT) // ADMIN, TEACHER, STUDENT
  status       UserStatus   @default(PENDING) // PENDING, ACTIVE, BLOCKED
  funcao       String?      @db.VarChar(255) @map("funcao") // Fun├º├úo/cargo (para usu├írios do ADM)
  emailPessoal String?      @map("email_pessoal") @db.VarChar(255) // Email pessoal (para usu├írios do ADM)
  adminPages   Json?        @map("admin_pages") // P├íginas do dashboard que pode acessar (array de strings)
  mustChangePassword Boolean @default(false) @map("must_change_password") // Professor: obrigar a alterar senha no primeiro acesso
  criadoEm     DateTime     @default(now()) @map("created_at")
  atualizadoEm DateTime     @updatedAt @map("updated_at")
  
  // Relacionamentos
  enrollments        Enrollment[]
  attendances        Attendance[]
  bookReleases       BookRelease[]
  teacher            Teacher?
  teacherAlertsCreated TeacherAlert[]
  studentAlertsCreated StudentAlert[]
  adminNotifications AdminNotification[]
  adminPaymentMonths AdminUserPaymentMonth[]
  kanbanCardsAssigned KanbanCard[]
  conversationParticipants ConversationParticipant[]
  chatMessagesSent ChatMessage[]
  lessonsCreated Lesson[]
  lessonRequestsCreated LessonRequest[] @relation("LessonRequestsCreated")
  lessonRequestsProcessed LessonRequest[] @relation("LessonRequestsProcessed")
  
  // ├ìndices
  @@index([email])
  @@index([role])
  @@index([status])
  @@map("users")
}

// Valor por m├¬s para usu├írios do ADM (exceto super admin) ÔÇô Financeiro Administra├º├úo
// valor = valor aprovado (fixo). Altera├º├Áes ficam em valorPendente at├® aprova├º├úo do admin.
model AdminUserPaymentMonth {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  year           Int
  month          Int       // 1-12
  valor          Decimal?  @db.Decimal(10, 2)   // valor aprovado (fixo)
  paymentStatus  String?   @map("payment_status") // PAGO, EM_ABERTO
  valorPendente  Decimal?  @map("valor_pendente") @db.Decimal(10, 2)  // altera├º├úo aguardando aprova├º├úo
  valorPendenteRequestedAt DateTime? @map("valor_pendente_requested_at")
  criadoEm       DateTime  @default(now()) @map("created_at")
  atualizadoEm   DateTime  @updatedAt @map("updated_at")

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([userId, year, month])
  @@index([userId])
  @@index([year, month])
  @@map("admin_user_payment_months")
}

// Despesas administrativas (outros gastos) – uma linha por ocorrência (mês)
model AdminExpense {
  id             String    @id @default(cuid())
  name           String    @map("name")       // Nome da despesa
  description    String?   @db.Text           // Descrição
  valor          Decimal   @db.Decimal(10, 2)
  year           Int
  month          Int       // 1-12
  paymentStatus  String?   @map("payment_status") // PAGO, EM_ABERTO
  isFixed        Boolean   @default(false) @map("is_fixed") // Despesa fixa (ex: internet, aluguel)
  criadoEm       DateTime  @default(now()) @map("created_at")
  atualizadoEm   DateTime  @updatedAt @map("updated_at")

  @@index([year, month])
  @@map("admin_expenses")
}

// Cupom de desconto: define valor por hora-aula e validade
model Coupon {
  id                 String    @id @default(cuid())
  nome               String    @db.VarChar(255) @map("nome")           // Nome do cupom (ex: "Desconto Black Friday")
  codigo             String?   @unique @db.VarChar(50) @map("codigo")   // C├│digo opcional (ex: BLACK20)
  valorPorHoraAula   Decimal   @db.Decimal(10, 2) @map("valor_por_hora_aula") // Valor que o aluno paga por hora-aula ao usar o cupom
  validade           DateTime? @map("validade")   // null = cupom permanente
  ativo              Boolean   @default(true) @map("ativo")
  criadoEm           DateTime  @default(now()) @map("created_at")
  atualizadoEm       DateTime  @updatedAt @map("updated_at")

  enrollments        Enrollment[]

  @@index([ativo])
  @@index([validade])
  @@map("coupons")
}

// Notifica├º├Áes para o admin (ex.: professor confirmou valor, professor alterou dados)
model AdminNotification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id") // Admin que v├¬ a notifica├º├úo
  message   String
  readAt    DateTime? @map("read_at")
  criadoEm  DateTime  @default(now()) @map("created_at")
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([readAt])
  @@map("admin_notifications")
}

// Kanban: blocos em colunas Para fazer, Fazendo, Feito (admin)
model KanbanCard {
  id              String   @id @default(cuid())
  title           String   @db.VarChar(500)
  setor           String?  @db.VarChar(100)   // setor
  assignedToId    String?  @map("assigned_to_id") // User (admin) que far├í
  column          String   @db.VarChar(20)   // TODO | DOING | DONE
  orderIndex      Int      @default(0) @map("order_index")
  prioridade      String?  @db.VarChar(20)  // EMERGENCIA | PODE_ESPERAR | FIQUE_ATENTO
  criadoEm        DateTime @default(now()) @map("created_at")
  atualizadoEm    DateTime @updatedAt @map("updated_at")

  assignedTo      User?    @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  @@index([column])
  @@index([assignedToId])
  @@map("kanban_cards")
}

// Chat interno: conversas entre funcion├írios, professores e alunos
model Conversation {
  id        String    @id @default(cuid())
  type      String    @db.VarChar(20) // DIRECT | GROUP
  name      String?   @db.VarChar(255) // Nome do grupo (opcional)
  criadoEm  DateTime  @default(now()) @map("created_at")

  participants ConversationParticipant[]
  messages     ChatMessage[]
  @@index([criadoEm])
  @@map("conversations")
}

model ConversationParticipant {
  id             String    @id @default(cuid())
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  criadoEm       DateTime  @default(now()) @map("created_at")
  lastReadAt     DateTime? @map("last_read_at") // para contagem de mensagens n├úo lidas

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String   @db.Text
  criadoEm       DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  @@index([conversationId])
  @@index([senderId])
  @@index([criadoEm])
  @@map("chat_messages")
}

// Model: Enrollment (Matr├¡cula / Aluno)
// Representa uma matr├¡cula/lead no sistema
model Enrollment {
  id             String           @id @default(cuid())
  userId         String?          @map("user_id")
  
  // Dados b├ísicos
  nome           String
  email          String
  whatsapp       String
  idioma         Language?    // Opcional
  nivel          String?
  objetivo       String?
  disponibilidade String?
  
  // Dados completos do aluno (cadastro admin)
  dataNascimento   DateTime?     @map("data_nascimento")
  nomeResponsavel  String?        @db.VarChar(255) @map("nome_responsavel") // se menor
  emailResponsavel String?        @db.VarChar(255) @map("email_responsavel") // se menor: usado para cobrança/NFSe
  cpf              String?        @db.VarChar(14)
  cpfResponsavel   String?        @db.VarChar(14) @map("cpf_responsavel")   // se menor
  curso            String?        @db.VarChar(50)  // INGLES, ESPANHOL, INGLES_E_ESPANHOL
  frequenciaSemanal Int?          @map("frequencia_semanal") // 1-7
  tempoAulaMinutos  Int?          @map("tempo_aula_minutos") // 30, 40, 60, 120
  tipoAula         String?        @db.VarChar(20) @map("tipo_aula") // PARTICULAR, GRUPO
  nomeGrupo        String?        @db.VarChar(255) @map("nome_grupo") // quando tipoAula = GRUPO
  cep               String?       @db.VarChar(9)
  rua               String?      @db.VarChar(255)
  cidade            String?      @db.VarChar(100)
  estado            String?      @db.VarChar(2)
  numero            String?      @db.VarChar(20)
  complemento       String?      @db.VarChar(255)
  moraNoExterior    Boolean      @default(false) @map("mora_no_exterior")
  enderecoExterior  String?      @db.Text @map("endereco_exterior")
  valorMensalidade  Decimal?     @db.Decimal(10, 2) @map("valor_mensalidade")
  metodoPagamento   String?      @db.VarChar(50) @map("metodo_pagamento")
  diaPagamento      Int?         @map("dia_pagamento") // 1-31
  melhoresHorarios  String?      @db.VarChar(255) @map("melhores_horarios")
  melhoresDiasSemana String?     @db.VarChar(255) @map("melhores_dias_semana")
  nomeVendedor      String?      @db.VarChar(255) @map("nome_vendedor")
  nomeEmpresaOuIndicador String?  @db.VarChar(255) @map("nome_empresa_ou_indicador")
  escolaMatricula   String?      @db.VarChar(50) @map("escola_matricula") // SEIDMANN, YOUBECOME, HIGHWAY, OUTRO
  escolaMatriculaOutro String?   @db.VarChar(255) @map("escola_matricula_outro") // Quando escolaMatricula = OUTRO
  cancelamentoAntecedenciaHoras Int? @map("cancelamento_antecedencia_horas") // Tempo m├¡nimo de anteced├¬ncia para cancelamento (em horas). Padr├úo: 6h para n├úo-YOUBECOME, 24h para YOUBECOME
  observacoes       String?      @db.Text
  pendenteAdicionarAulas Boolean @default(false) @map("pendente_adicionar_aulas") // true = matriculado pelo formul├írio, ainda n├úo marcou "j├í adicionei aulas"
  linkPagamentoEnviadoAt DateTime? @map("link_pagamento_enviado_at") // data em que o admin marcou "enviei link pag"

  status         EnrollmentStatus @default(LEAD)
  inactiveAt     DateTime?        @map("inactive_at") // Data em que foi marcado como inativo (para hist├│rico por m├¬s)
  pausedAt       DateTime?        @map("paused_at") // Data em que foi marcado como pausado (aulas n├úo contam para pagamento a partir desta data)
  activationDate DateTime?        @map("activation_date") // Data de ativa├º├úo para alunos pausados (volta para ACTIVE automaticamente nesta data)
  trackingCode   String?          @unique @map("tracking_code")
  contractAcceptedAt DateTime?    @map("contract_accepted_at")
  contractVersion    String?      @map("contract_version")
  couponId       String?          @map("coupon_id") // Cupom usado na inscri├º├úo
  criadoEm       DateTime         @default(now()) @map("created_at")
  atualizadoEm   DateTime         @updatedAt @map("updated_at")
  
  // Relacionamentos
  user           User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  coupon         Coupon?          @relation(fields: [couponId], references: [id], onDelete: SetNull)
  paymentInfo    PaymentInfo?
  paymentMonths       EnrollmentPaymentMonth[]
  financeObservations FinanceObservation[]
  nfseInvoices           NfseInvoice[]
  alerts                 StudentAlert[]
  paymentNotifications   PaymentNotification[]
  coraInvoices          CoraInvoice[]
  lessons             Lesson[]
  lessonRequests      LessonRequest[]
  lessonRecordPresences LessonRecordStudent[]

  @@index([email])
  @@index([whatsapp])
  @@index([trackingCode])
  @@index([couponId])
  @@map("enrollments")
}

// Model: PaymentInfo (Informa├º├Áes de Pagamento)
// Informa├º├Áes de pagamento vinculadas a uma matr├¡cula
model PaymentInfo {
  id                  String          @id @default(cuid())
  enrollmentId        String          @unique @map("enrollment_id")
  metodo              PaymentMethod   @default(PIX)
  plan                String?         // Ex: "1h semanal", "2h semanais", "grupo 2h"
  valorMensal         Decimal?        @db.Decimal(10, 2) @map("valor_mensal") // Valor combinado mensal
  monthlyValue        Decimal?        @db.Decimal(10, 2) @map("monthly_value")
  dataPagamento       DateTime?       @map("data_pagamento")
  dueDay              Int?            @map("due_day") // Dia do m├¬s (1-31)
  dueDate             DateTime?       @map("due_date") // Data espec├¡fica de vencimento
  reminderEnabled     Boolean         @default(true) @map("reminder_enabled")
  paymentStatus       String?         @map("payment_status") // PAGO, ATRASADO, PENDING
  paidAt              DateTime?       @map("paid_at") // data ├║ltimo pagamento
  transactionRef      String?         @map("transaction_ref") // Refer├¬ncia da transa├º├úo
  lembrete            Boolean         @default(false) // Mantido para compatibilidade
  quemPaga            String?         @db.VarChar(255) @map("quem_paga") // Quem paga (funcion├írio financeiro adiciona)
  valorHora           Decimal?        @db.Decimal(10, 2) @map("valor_hora") // Valor da hora
  banco               String?         @db.VarChar(100) @map("banco")
  periodoPagamento    String?         @db.VarChar(20) @map("periodo_pagamento") // MENSAL, ANUAL, SEMESTRAL, TRIMESTRAL
  notaFiscalEmitida   Boolean?        @map("nota_fiscal_emitida") // Nota fiscal emitida?
  criadoEm            DateTime        @default(now()) @map("created_at")
  atualizadoEm        DateTime        @updatedAt @map("updated_at")
  
  // Relacionamento
  enrollment          Enrollment      @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@map("payment_info")
}

// Status e NF por m├¬s/ano (independentes por m├¬s; ├║nico global ├® paidAt em PaymentInfo)
model EnrollmentPaymentMonth {
  id                   String   @id @default(cuid())
  enrollmentId         String   @map("enrollment_id")
  year                 Int
  month                Int      // 1-12
  paymentStatus        String?  @map("payment_status") // PAGO, ATRASADO, PENDING
  notaFiscalEmitida    Boolean? @map("nota_fiscal_emitida")
  criadoEm             DateTime @default(now()) @map("created_at")
  atualizadoEm         DateTime @updatedAt @map("updated_at")

  enrollment           Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, year, month])
  @@index([enrollmentId])
  @@map("enrollment_payment_months")
}

// Model: NfseInvoice (Nota Fiscal de Serviços Eletrônica)
// Representa uma NFSe emitida via Focus NFe
model NfseInvoice {
  id                String    @id @default(cuid())
  enrollmentId      String    @map("enrollment_id")
  studentName       String    @db.VarChar(255) @map("student_name")
  cpf               String    @db.VarChar(14)
  email             String?   @db.VarChar(255)
  year              Int
  month             Int       // 1-12
  amount            Decimal   @db.Decimal(10, 2)
  
  // Focus NFe
  focusRef          String    @unique @db.VarChar(255) @map("focus_ref")
  status            String    @default("processando_autorizacao") @db.VarChar(50)
  numero            String?   @db.VarChar(50)
  codigoVerificacao String?   @db.VarChar(100) @map("codigo_verificacao")
  pdfUrl            String?   @db.Text @map("pdf_url")
  xmlUrl            String?   @db.Text @map("xml_url")
  errorMessage      String?   @db.Text @map("error_message")
  
  // Cancelamento
  cancelledAt       DateTime? @map("cancelled_at")
  cancelReason      String?   @db.Text @map("cancel_reason")
  
  // Audit
  criadoEm          DateTime  @default(now()) @map("created_at")
  atualizadoEm      DateTime  @updatedAt @map("updated_at")
  
  enrollment        Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@unique([enrollmentId, year, month])
  @@index([status])
  @@index([year, month])
  @@index([criadoEm])
  @@map("nfse_invoices")
}

// Observa├º├Áes financeiras (aluno ou professor) ÔÇô lista, adicionar, apagar
model FinanceObservation {
  id           String    @id @default(cuid())
  enrollmentId String?   @map("enrollment_id")
  teacherId    String?   @map("teacher_id")
  message      String    @db.Text
  criadoEm     DateTime  @default(now()) @map("created_at")

  enrollment   Enrollment? @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  teacher      Teacher?    @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([enrollmentId])
  @@index([teacherId])
  @@map("finance_observations")
}

// Model: Teacher (Professor)
// Representa um professor do instituto
model Teacher {
  id              String       @id @default(cuid())
  nome            String
  nomePreferido   String?      @map("nome_preferido") // Nome que prefere ser chamado
  email           String       @unique
  whatsapp        String?
  cpf             String?      // CPF (opcional)
  cnpj            String?      // CNPJ (opcional)
  valorPorHora    Decimal?     @db.Decimal(10, 2) @map("valor_por_hora")
  metodoPagamento String?      @map("metodo_pagamento") // PIX, CARTAO
  infosPagamento  String?      @db.Text @map("infos_pagamento")
  nota            Int?         // Avalia├º├úo 1-5 estrelas
  status          UserStatus   @default(ACTIVE) // ACTIVE ou INACTIVE
  userId          String?      @unique @map("user_id") // Opcional: link com User se tiver conta
  periodoPagamentoInicio  DateTime? @map("periodo_pagamento_inicio") // Data in├¡cio do per├¡odo de pagamento (por professor)
  periodoPagamentoTermino DateTime? @map("periodo_pagamento_termino") // Data t├®rmino do per├¡odo de pagamento (por professor)
  periodoPagamentoPago    Boolean   @default(false) @map("periodo_pagamento_pago") // Pagamento do per├¡odo: true = Pago, false = Em aberto
  valorPorPeriodo         Decimal?  @db.Decimal(10, 2) @map("valor_por_periodo") // Valor fixo por per├¡odo (opcional)
  valorExtra              Decimal?  @db.Decimal(10, 2) @map("valor_extra") // Valores extras do per├¡odo (opcional)
  idiomasFala             Json?     @map("idiomas_fala") // ["INGLES","ESPANHOL","PORTUGUES","ITALIANO","FRANCES"]
  idiomasEnsina           Json?     @map("idiomas_ensina") // idiomas que o professor ensina
  criadoEm        DateTime     @default(now()) @map("created_at")
  atualizadoEm    DateTime     @updatedAt @map("updated_at")
  
  // Relacionamentos
  user              User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  attendances       Attendance[]
  alerts            TeacherAlert[]
  lessons           Lesson[]
  lessonRequests    LessonRequest[]
  requestedLessonRequests LessonRequest[] @relation("RequestedTeacher")
  paymentMonths       TeacherPaymentMonth[]
  availabilitySlots   TeacherAvailabilitySlot[]
  financeObservations FinanceObservation[]

  // ├ìndices
  @@index([email])
  @@index([status])
  @@map("teachers")
}

// Hor├írios em que o professor est├í dispon├¡vel (gest├úo ou professor podem cadastrar)
model TeacherAvailabilitySlot {
  id           String   @id @default(cuid())
  teacherId    String   @map("teacher_id")
  dayOfWeek    Int      @map("day_of_week") // 0=Dom, 1=Seg, ..., 6=S├íb
  startMinutes Int      @map("start_minutes") // 0-1439 (ex: 540 = 09:00)
  endMinutes   Int      @map("end_minutes")   // 0-1439 (ex: 720 = 12:00)
  criadoEm     DateTime @default(now()) @map("created_at")

  teacher      Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@map("teacher_availability_slots")
}

// Status e valores por m├¬s/ano (independentes por m├¬s), como EnrollmentPaymentMonth para alunos
model TeacherPaymentMonth {
  id                  String    @id @default(cuid())
  teacherId           String    @map("teacher_id")
  year                Int
  month               Int       // 1-12
  paymentStatus       String?   @map("payment_status") // PAGO, EM_ABERTO
  valorPorPeriodo     Decimal?  @db.Decimal(10, 2) @map("valor_por_periodo")
  valorExtra          Decimal?  @db.Decimal(10, 2) @map("valor_extra")
  periodoInicio       DateTime? @map("periodo_inicio") // Ex.: 15/01 para per├¡odo 15 jan a 15 fev
  periodoTermino      DateTime? @map("periodo_termino")
  teacherConfirmedAt  DateTime? @map("teacher_confirmed_at") // Professor clicou "Confirmar valor a receber" ÔåÆ admin v├¬ "pagamento pronto para fazer"
  proofSentAt         DateTime? @map("proof_sent_at") // Professor enviou nota fiscal/recibo para financeiro@
  criadoEm            DateTime  @default(now()) @map("created_at")
  atualizadoEm        DateTime  @updatedAt @map("updated_at")

  teacher             Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, year, month])
  @@index([teacherId])
  @@map("teacher_payment_months")
}

// Model: Attendance (Frequ├¬ncia/Falta)
// Registra presen├ºa ou falta de alunos e professores
model Attendance {
  id           String           @id @default(cuid())
  type         AttendanceType   // STUDENT ou TEACHER
  status       AttendanceStatus // PRESENT ou ABSENT (falta = ABSENT)
  userId       String?          @map("user_id") // Para aluno
  teacherId    String?          @map("teacher_id") // Para professor
  date         DateTime         // Data do evento
  notes        String?          // Observa├º├Áes opcionais
  criadoEm     DateTime         @default(now()) @map("created_at")
  atualizadoEm DateTime         @updatedAt @map("updated_at")
  
  // Relacionamentos
  user         User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacher      Teacher?         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // ├ìndices para consultas r├ípidas
  @@index([type, date])
  @@index([userId, date])
  @@index([teacherId, date])
  @@map("attendances")
}

// Model: Book (Cat├ílogo de Livros)
// Livros cadastrados com PDF, capa, n├¡vel, etc. Usado para liberar aos alunos.
model Book {
  id             String   @id @default(cuid())
  nome           String   @db.VarChar(255) @map("nome")
  level          String   @db.VarChar(20) @map("level")   // A1, A2, A3, B1, B2, B3, B4, C1, C2
  totalPaginas   Int      @map("total_paginas")
  imprimivel     Boolean  @default(true) @map("imprimivel")
  pdfPath        String?  @db.VarChar(500) @map("pdf_path")  // Caminho relativo: /uploads/books/{id}/livro.pdf
  capaPath       String?  @db.VarChar(500) @map("capa_path") // Caminho relativo: /uploads/books/{id}/capa.jpg
  criadoEm       DateTime @default(now()) @map("created_at")
  atualizadoEm   DateTime @updatedAt @map("updated_at")

  releases       BookRelease[]

  @@index([level])
  @@map("books")
}

// Model: BookRelease (Libera├º├úo de Livro)
// Registra quando um livro foi liberado para um aluno
model BookRelease {
  id                   String   @id @default(cuid())
  userId               String   @map("user_id")
  bookCode             String   // ID do Book (cat├ílogo) ou c├│digo manual legado
  bookId               String?  @map("book_id") // FK opcional para livro do cat├ílogo
  releasedByAdminEmail String   @map("released_by_admin_email")
  criadoEm             DateTime @default(now()) @map("created_at")
  
  // Relacionamentos
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  book                 Book?    @relation(fields: [bookId], references: [id], onDelete: SetNull)
  
  // Garantir que um aluno n├úo receba o mesmo livro duas vezes
  @@unique([userId, bookCode], name: "userId_bookCode")
  @@index([userId])
  @@index([bookCode])
  @@index([bookId])
  @@map("book_releases")
}

// Model: Announcement (An├║ncio/Alerta)
// An├║ncios enviados para usu├írios (email ou SMS)
model Announcement {
  id                  String              @id @default(cuid())
  title               String
  message             String
  channel             AnnouncementChannel  // EMAIL ou SMS
  audience            String              // "ALL", "STUDENTS", "TEACHERS", "ACTIVE_ONLY"
  status              AnnouncementStatus  @default(PENDING)
  createdByAdminEmail String              @map("created_by_admin_email")
  sentAt              DateTime?           @map("sent_at")
  criadoEm            DateTime            @default(now()) @map("created_at")
  atualizadoEm        DateTime            @updatedAt @map("updated_at")
  
  // ├ìndices
  @@index([status])
  @@index([channel])
  @@index([criadoEm])
  @@map("announcements")
}

// Model: TeacherAlert (Alerta para Professor)
// Alertas espec├¡ficos para professores. type = PAYMENT_DONE | NEW_ANNOUNCEMENT | NEW_STUDENT (s├│ esses aparecem no In├¡cio)
model TeacherAlert {
  id           String    @id @default(cuid())
  teacherId    String    @map("teacher_id")
  message      String
  type         String?   @db.VarChar(32) // PAYMENT_DONE, NEW_ANNOUNCEMENT, NEW_STUDENT (notifica├º├Áes exibidas no In├¡cio)
  level        String?   // "INFO", "WARN", "ERROR"
  isActive     Boolean   @default(true) @map("is_active")
  readAt       DateTime? @map("read_at") // quando o professor leu (null = n├úo lido)
  criadoEm     DateTime  @default(now()) @map("created_at")
  atualizadoEm DateTime  @updatedAt @map("updated_at")
  createdById  String?   @map("created_by_id") // Admin que criou o alerta
  
  // Relacionamentos
  teacher      Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  createdBy    User?     @relation(fields: [createdById], references: [id], onDelete: SetNull)
  
  // ├ìndices
  @@index([teacherId])
  @@index([isActive])
  @@index([type])
  @@map("teacher_alerts")
}

// Solicita├º├úo de novo professor: hor├írios e idiomas desejados (admin cria; pode apagar ao encontrar professor)
model TeacherRequest {
  id          String   @id @default(cuid())
  horarios    String   @db.Text   // Descri├º├úo dos hor├írios (ex: "Seg 9h, Qua 14h")
  idiomas     String   @db.VarChar(255) // Idiomas desejados (ex: "INGLES, ESPANHOL")
  criadoEm    DateTime @default(now()) @map("created_at")

  @@map("teacher_requests")
}

// Model: StudentAlert (Alerta para Aluno/Matr├¡cula)
// Alertas espec├¡ficos para alunos (como TeacherAlert para professores)
model StudentAlert {
  id            String     @id @default(cuid())
  enrollmentId  String     @map("enrollment_id")
  message       String
  level         String?    // "INFO", "WARN", "ERROR"
  isActive      Boolean    @default(true) @map("is_active")
  readAt        DateTime?  @map("read_at") // quando o aluno leu (null = n├úo lido); ap├│s 2 dias n├úo ├® mais exibido
  criadoEm      DateTime   @default(now()) @map("created_at")
  atualizadoEm  DateTime   @updatedAt @map("updated_at")
  createdById   String?    @map("created_by_id")

  enrollment    Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  createdBy     User?      @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([enrollmentId])
  @@index([isActive])
  @@index([readAt])
  @@map("student_alerts")
}

// Status da aula no calend├írio (segunda a s├íbado = semana para frequ├¬ncia)
enum LessonStatus {
  CONFIRMED   // Confirmada
  CANCELLED   // Cancelada
  REPOSICAO   // Reposi├º├úo
}

// Enums para solicita├º├Áes de aula
enum LessonRequestType {
  CANCELAMENTO
  TROCA_PROFESSOR
  TROCA_AULA
}

enum LessonRequestStatus {
  PENDING
  TEACHER_APPROVED
  TEACHER_REJECTED
  ADMIN_APPROVED
  ADMIN_REJECTED
  COMPLETED
}

// Feriado: dia em que n├úo se pode adicionar aula e aulas n├úo contam para pagamento
model Holiday {
  id        String   @id @default(cuid())
  dateKey   String   @unique @map("date_key") // YYYY-MM-DD
  criadoEm  DateTime @default(now()) @map("created_at")

  @@map("holidays")
}

// Model: Lesson (Aula no calend├írio)
// Aula agendada: aluno (enrollment) + professor + status + data/hora
model Lesson {
  id                String       @id @default(cuid())
  enrollmentId      String       @map("enrollment_id")
  teacherId         String       @map("teacher_id")
  status            LessonStatus @default(CONFIRMED)
  startAt           DateTime     @map("start_at")
  durationMinutes   Int          @default(60) @map("duration_minutes")
  notes             String?      @db.Text
  createdById       String?      @map("created_by_id") // Admin que criou/agendou a aula
  createdByName     String?      @map("created_by_name") @db.VarChar(255) // Nome do admin que criou (para exibi├º├úo r├ípida)
  criadoEm          DateTime     @default(now()) @map("created_at")
  atualizadoEm      DateTime     @updatedAt @map("updated_at")

  enrollment        Enrollment   @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  teacher           Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  record            LessonRecord?
  createdBy         User?        @relation(fields: [createdById], references: [id], onDelete: SetNull)
  requests           LessonRequest[]

  @@index([startAt])
  @@index([enrollmentId])
  @@index([teacherId])
  @@index([createdById])
  @@map("lessons")
}

// Presen├ºa do aluno no registro de aula
enum RecordPresence {
  PRESENTE       // Presente
  NAO_COMPARECEU // N├úo compareceu
  ATRASADO       // Atrasado
}

// Tipo de aula no registro
enum RecordLessonType {
  NORMAL        // Normal
  CONVERSAÇÃO   // Só conversação
  REVISAO       // Revis├úo
  AVALIACAO     // Avalia├º├úo
}

// ├Ültima tarefa feita
enum RecordHomeworkDone {
  SIM          // Sim
  NAO          // N├úo
  PARCIAL      // Parcial
  NAO_APLICA   // N├úo aplica
}

// Model: LessonRecord (Registro de aula)
// Registro do que aconteceu na aula: presen├ºa, tipo, livro, p├ígina, tarefa, notas (se avalia├º├úo)
model LessonRecord {
  id                      String            @id @default(cuid())
  lessonId                String            @unique @map("lesson_id")
  status                  LessonStatus      @default(CONFIRMED) // status da aula: confirmada, cancelada, reposi├º├úo
  presence                RecordPresence    @default(PRESENTE)
  lessonType              RecordLessonType  @default(NORMAL) @map("lesson_type")
  curso                   String?           @db.VarChar(50) // INGLES, ESPANHOL, INGLES_E_ESPANHOL
  tempoAulaMinutos        Int?             @map("tempo_aula_minutos") // preenchido automaticamente da aula selecionada
  book                    String?           @db.VarChar(255) // livro do aluno
  lastPage                String?           @db.VarChar(100) @map("last_page") // ├║ltima p├ígina trabalhada
  assignedHomework        String?           @db.Text @map("assigned_homework") // tarefa designada
  homeworkDone            RecordHomeworkDone? @map("homework_done") // ├║ltima tarefa feita
  conversationDescription String?           @db.Text @map("conversation_description") // descri├º├úo da aula de conversa├º├úo (quando tipo = S├│ conversa├º├úo)
  notes                   String?           @db.Text // obs geral
  notesForStudent         String?           @db.Text @map("notes_for_student") // obs para os alunos
  notesForParents         String?           @db.Text @map("notes_for_parents") // obs para os pais
  gradeGrammar            Float?            @map("grade_grammar")
  gradeSpeaking           Float?            @map("grade_speaking")
  gradeListening          Float?            @map("grade_listening")
  gradeUnderstanding      Float?            @map("grade_understanding")
  criadoEm                DateTime          @default(now()) @map("created_at")
  atualizadoEm            DateTime          @updatedAt @map("updated_at")

  lesson                  Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  studentPresences        LessonRecordStudent[] // quando aula ├® em grupo: presen├ºa por aluno

  @@index([lessonId])
  @@index([status])
  @@map("lesson_records")
}

// Presen├ºa por aluno em aula em grupo (um registro por aluno do grupo)
model LessonRecordStudent {
  id              String          @id @default(cuid())
  lessonRecordId  String          @map("lesson_record_id")
  enrollmentId    String          @map("enrollment_id")
  presence        RecordPresence  @default(PRESENTE)

  lessonRecord    LessonRecord    @relation(fields: [lessonRecordId], references: [id], onDelete: Cascade)
  enrollment      Enrollment      @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([lessonRecordId, enrollmentId])
  @@index([lessonRecordId])
  @@index([enrollmentId])
  @@map("lesson_record_students")
}

// Solicita├º├Áes de cancelamento/troca de aula ou professor
model LessonRequest {
  id                String              @id @default(cuid())
  lessonId          String              @map("lesson_id")
  enrollmentId      String              @map("enrollment_id")
  teacherId         String              @map("teacher_id")
  type              LessonRequestType
  status            LessonRequestStatus @default(PENDING)
  requiresTeacherApproval Boolean       @default(false) @map("requires_teacher_approval")
  teacherApproval   String?             @db.VarChar(20) @map("teacher_approval")
  teacherApprovedAt  DateTime?          @map("teacher_approved_at")
  requestedStartAt  DateTime?           @map("requested_start_at")
  requestedTeacherId String?            @map("requested_teacher_id")
  notes             String?             @db.Text
  adminNotes        String?             @db.Text @map("admin_notes")
  createdById       String?             @map("created_by_id")
  processedById     String?             @map("processed_by_id")
  criadoEm          DateTime            @default(now()) @map("created_at")
  atualizadoEm      DateTime            @updatedAt @map("updated_at")

  lesson            Lesson              @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  enrollment        Enrollment          @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  teacher           Teacher             @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  requestedTeacher  Teacher?            @relation("RequestedTeacher", fields: [requestedTeacherId], references: [id], onDelete: SetNull)
  createdBy         User?               @relation("LessonRequestsCreated", fields: [createdById], references: [id], onDelete: SetNull)
  processedBy       User?               @relation("LessonRequestsProcessed", fields: [processedById], references: [id], onDelete: SetNull)

  @@index([lessonId])
  @@index([enrollmentId])
  @@index([teacherId])
  @@index([requestedTeacherId])
  @@index([status])
  @@index([createdById])
  @@index([type])
  @@index([requiresTeacherApproval])
  @@index([teacherApproval])
  @@map("lesson_requests")
}

// Boletos PIX/boleto gerados na Cora
model CoraInvoice {
  id             String    @id @default(cuid())
  enrollmentId   String    @map("enrollment_id")
  enrollment     Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  coraInvoiceId  String    @unique @map("cora_invoice_id")
  code           String    @unique @db.VarChar(100)
  year           Int
  month          Int       // 1-12
  amount         Int       // Centavos
  dueDate        DateTime  @map("due_date")
  status         String    @default("OPEN") @db.VarChar(20) // OPEN, PAID, CANCELLED, LATE
  digitableLine  String?   @map("digitable_line") @db.Text
  barCode        String?   @map("bar_code") @db.Text
  pixQrCode      String?   @map("pix_qr_code") @db.Text
  pixCopyPaste   String?   @map("pix_copy_paste") @db.Text
  boletoUrl      String?   @map("boleto_url") @db.Text
  paidAt         DateTime? @map("paid_at")
  paidAmount     Int?      @map("paid_amount") // Centavos
  criadoEm       DateTime  @default(now()) @map("created_at")
  atualizadoEm   DateTime  @updatedAt @map("updated_at")

  @@unique([enrollmentId, year, month])
  @@index([status])
  @@index([coraInvoiceId])
  @@index([dueDate])
  @@map("cora_invoices")
}

// Eventos de webhook Cora processados (idempotência)
model CoraWebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique @map("event_id") @db.VarChar(100)
  processedAt DateTime @default(now()) @map("processed_at")

  @@map("cora_webhook_events")
}

// Controle de notificações de pagamento enviadas por email
model PaymentNotification {
  id           String    @id @default(cuid())
  enrollmentId String    @map("enrollment_id")
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  type         String    @db.VarChar(50) // reminder_10, reminder_5, reminder_3, overdue_1..8, payment_confirmed, deactivated
  year         Int
  month        Int       // 1-12
  sentAt       DateTime  @default(now()) @map("sent_at")
  emailTo      String    @map("email_to") @db.VarChar(255)
  success      Boolean   @default(true)
  errorMessage String?   @map("error_message") @db.Text

  @@unique([enrollmentId, type, year, month])
  @@index([type, year, month])
  @@index([sentAt])
  @@map("payment_notifications")
}

// Audit log para mudanças financeiras (Cora, status de pagamento, etc.)
model FinanceAuditLog {
  id          String   @id @default(cuid())
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  action      String
  oldValue    Json?    @map("old_value")
  newValue    Json?    @map("new_value")
  performedBy String?  @map("performed_by")
  metadata    Json?
  criadoEm    DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([criadoEm])
  @@map("finance_audit_logs")
}
